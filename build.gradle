// import com.redpillanalytics.aws.tasks.S3UploadSyncTask
// import com.redpillanalytics.aws.tasks.S3DownloadSyncTask

plugins {
   id 'groovy'
   id 'java-gradle-plugin'
   id "com.gradle.plugin-publish" version "0.10.1"
   id "pl.allegro.tech.build.axion-release" version "1.10.0"
   id "com.github.breadmoirai.github-release" version "2.2.6"
   id 'org.unbroken-dome.test-sets' version '2.1.1'
   id "com.avast.gradle.docker-compose" version "0.9.1"
   id "com.github.ben-manes.versions" version "0.21.0"
   id "com.redpillanalytics.gradle-analytics" version "1.2.3"
   id 'com.adarshr.test-logger' version '1.6.0'
   //id "com.redpillanalytics.gradle-aws" version "0.1.4"
}

// test {
//    failFast = true
// }

// send analytics
analytics {
   organization = 'Red Pill Analytics'
   sinks {
      pubsub
   }
}

scmVersion {

   tag {
      prefix = 'v'
      versionSeparator = ''
   }
   ignoreUncommittedChanges = true
}

//set Gradle version to SCM Version
allprojects {
   project.version = scmVersion.version
}

githubRelease {

   token = githubToken
   owner = 'RedPillAnalytics'
   repo = 'gradle-confluent'
   tagName = "v${version}"
   releaseAssets = fileTree(dir: buildDir, includes: ["**/*${version}*", "**/*${version}*.jar"]).toList()
}

dependencies {

   compile gradleApi()
   compile localGroovy()

   compile group: 'org.slf4j', name: 'slf4j-simple', version: '+'
   compile 'com.mashape.unirest:unirest-java:+'

   // Gradle Analytics plugin
   // It also has the Common library in it, thus the dependency here
   compile "gradle.plugin.com.redpillanalytics:gradle-analytics:+"

   testCompile 'org.spockframework:spock-core:1.2-groovy-2.5'
}

// Default artifact naming.
group = 'com.redpillanalytics'

repositories {
   jcenter()
   maven {
      url "https://plugins.gradle.org/m2/"
   }
}

gradlePlugin {
   plugins {
      gradleConfluent {
         id = 'com.redpillanalytics.gradle-confluent'
         implementationClass = 'com.redpillanalytics.gradle.ConfluentPlugin'
      }
   }
}

pluginBundle {

   website = 'https://github.com/RedPillAnalytics/gradle-confluent'
   vcsUrl = 'https://github.com/RedPillAnalytics/gradle-confluent'

   plugins {

      gradleConfluent {
         id = 'com.redpillanalytics.gradle-confluent'
         displayName = 'gradle-confluent'
         description = "A plugin for deploying streaming applications to a Confluent Kafka cluster."
         tags = ['kafka', 'confluent', 'ksql', 'streams']
         version = project.version
      }
   }
}

// Options for all tests
tasks.withType(Test) {
   ignoreFailures true
   testLogging.showStandardStreams true
   systemProperty 'projectDir', temporaryDir
}

testSets {
   ksqlServerTest
   ksqlPipelinesTest
   deployTest
   buildTest
}

task cleanJunit(type: Delete) {
   delete getTestResultsDir()
}

task cleanLibs(type: Delete) {
   delete getLibsDir()
}

ext.docsBucket = 'documentation.redpillanalytics.com'
ext.resourceBucket = 'rpa-build-resources'

// task publishVersionDocs(type: S3UploadSyncTask) {

//    description = 'Upload version Groovydocs to s3.'
//    group = 'documentation'

//    bucketName docsBucket
//    filePath groovydoc.destinationDir.getPath()
//    keyName "${rootProject.name}/${version}"

//    dependsOn groovydoc
// }

// task publishLatestDocs(type: S3UploadSyncTask) {

//    description = 'Upload latest Groovydocs to s3.'
//    group = 'documentation'

//    bucketName docsBucket
//    filePath groovydoc.destinationDir.getPath()
//    keyName "${rootProject.name}/latest"

//    dependsOn groovydoc
// }

// task copyBuildResources(type: S3DownloadSyncTask) {
//    description 'Copy build resource files from S3.'
//    group 'build'
//    bucketName resourceBucket
//    keyName 'gradle'
//    filePath gradle.getGradleUserHomeDir().toString()
//    doFirst {
//       logger.warn "gradle home: ${gradle.getGradleUserHomeDir().toString()}"
//    }
// }

task runAllTests {
   description 'Run all defined tests.'
   group 'verification'
}

tasks.withType(Test) {
   runAllTests.dependsOn it
}
